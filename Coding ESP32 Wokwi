#include <Servo.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

Servo servo_15;
LiquidCrystal_I2C lcd(0x27, 16, 2);

int ultrasonicsensor = 0;
unsigned long lastDetected = 0;
bool detected = false;

int messageIndex = 0;
int totalMessages = 5;
bool messagesDone = false;  
unsigned long lastMessageChange = 0;

String messages[] = {
  " SELAMAT DATANG |  DI SICANTIK ",
  "SAMPAH INOVATIF |  CEGAH JENTIK",
  "  HIJAU UNTUK   | SAMPAH ORGANIK",
  "  ORANYE UNTUK  |SAMPAH ANORGANIK",
  "  TERIMA KASIH  |                     "
};

long readUltrasonicDistance(int triggerPin, int echoPin) {
  pinMode(triggerPin, OUTPUT);  
  digitalWrite(triggerPin, LOW);
  delayMicroseconds(2);
  digitalWrite(triggerPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(triggerPin, LOW);
  pinMode(echoPin, INPUT);
  return pulseIn(echoPin, HIGH);
}

void setup() {
  Serial.begin(9600);
  servo_15.attach(15, 500, 2500);
  pinMode(33, OUTPUT);
  pinMode(32, OUTPUT);
  pinMode(14, OUTPUT);
  lcd.init();
  lcd.backlight();   
}

void loop() {
  ultrasonicsensor = 0.01723 * readUltrasonicDistance(26, 25);
  Serial.println(ultrasonicsensor);

  unsigned long now = millis();

  if (ultrasonicsensor > 0 && ultrasonicsensor <= 200) {
    // === OBJEK TERDETEKSI ===
    servo_15.write(120);
    digitalWrite(33, HIGH);
    digitalWrite(32, HIGH);
    digitalWrite(14, HIGH);
    detected = true;
    lastDetected = now;

    // reset agar LCD bisa menampilkan lagi
    if (messagesDone) {
      messagesDone = false;
      messageIndex = 0;
    }

    // ganti pesan tiap 1,5 detik
    if (now - lastMessageChange > 1500) {
      lcd.clear();
      lcd.setCursor(0,0);
      lcd.print(messages[messageIndex].substring(0, min(16, messages[messageIndex].length())));
      lcd.setCursor(0,1);
      lcd.print(messages[messageIndex].substring(min(16, messages[messageIndex].length())));
      messageIndex = (messageIndex + 1) % totalMessages; // loop terus
      lastMessageChange = now;

      // menandai sudah menampilkan semua pesan sekali
      if (messageIndex == 0) messagesDone = true;
    }

  } else {
    // === TIDAK TERDETEKSI ===
    if (detected) {
      servo_15.write(0);  
      detected = false;
    }

    // matikan LCD jika semua pesan sudah ditampilkan sekali
    if (messagesDone) {
      lcd.clear();
      lcd.noBacklight();
    }

    // matikan LED setelah 5 detik
    if (now - lastDetected >= 5000) {
      digitalWrite(33, LOW);
      digitalWrite(32, LOW);
      digitalWrite(14, LOW);
    }
  }
}
